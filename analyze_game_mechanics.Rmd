---
title: "Analyzing Board Game Mechanics"
author: Phil Henrickson
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
---

This notebook is for examining boardgame mechanics.

```{r global seetings, echo=F, warning=F, message=F}

knitr::opts_chunk$set(echo = F,
                      messages=F,
                      warning=F,
                      dev="png",
                      fig.width = 8,
                      fig.height = 8)


options(knitr.duplicate.label = "allow")

options(scipen=999)

```

```{r load and set packages, warning=F, message=F, include=FALSE, results = 'hide'}

source("load_packages.R")
source("theme_phil.R")

```

## Connect to Big Query

We'll first connect to the most recent day of BGG data that we have in our database. We'll connect to the active games file.

```{r connect to big query}

library(bigrquery)

# get project credentials
PROJECT_ID <- "gcp-analytics-326219"
BUCKET_NAME <- "test-bucket"


# establish connection
bigquerycon<-dbConnect(
        bigrquery::bigquery(),
        project = PROJECT_ID,
        dataset = "bgg"
)

# query table
active_games<-DBI::dbGetQuery(bigquerycon, 
                              'SELECT * FROM bgg.active_games_daily')

# bgg_rankings<-bq_table_query(bq_bgg,
#                         query = 
#                         quiet = F)

# # set project and schema
# bq_bgg<- bq_dataset(project = PROJECT_ID,
#                                     dataset = 'bgg')

```

We'll then pull down various tables we need: mechanics, publishers, designers, categories.

```{r connect to id tables}

game_info<-DBI::dbGetQuery(bigquerycon,
                          'SELECT 
                          a.game_id,
                          a.name,
                          b.yearpublished
                          FROM bgg.game_ids a
                          LEFT JOIN bgg.game_yearpublished b
                          ON a.game_id = b.game_id')

game_mechanics<-DBI::dbGetQuery(bigquerycon, 
                              'SELECT 
                              a.game_id,
                              b.mechanic_id,
                              b.mechanic
                              FROM bgg.game_mechanics a
                               LEFT JOIN bgg.mechanic_ids b 
                               ON a.mechanic_id = b.mechanic_id')

game_publishers<-DBI::dbGetQuery(bigquerycon, 
                              'SELECT 
                              a.game_id,
                              b.publisher_id,
                              b.publisher
                              FROM bgg.game_publishers a
                               LEFT JOIN bgg.publisher_ids b 
                               ON a.publisher_id = b.publisher_id')

game_designers<-DBI::dbGetQuery(bigquerycon, 
                              'SELECT 
                              a.game_id,
                              b.designer_id,
                              b.designer
                              FROM bgg.game_designers a
                               LEFT JOIN bgg.designer_ids b 
                               ON a.designer_id = b.designer_id')

game_categories<-DBI::dbGetQuery(bigquerycon, 
                              'SELECT 
                              a.game_id,
                              b.category_id,
                              b.category
                              FROM bgg.game_categories a
                               LEFT JOIN bgg.category_ids b 
                               ON a.category_id = b.category_id')

```

I'm storing the data in a long format, we really would like to get this into a wide format.

```{r pivot these id tables}

mechanics_pivot<-game_mechanics %>%
 #       filter(game_id == 124361) %>%
        mutate(mechanic = tolower(paste("mech", gsub("[[:space:]]", "_", gsub("\\s+", " ", gsub("[[:punct:]]","", mechanic))), sep="_"))) %>%
        mutate(has_mechanic = 1) %>%
        select(-mechanic_id) %>%
        pivot_wider(names_from = c("mechanic"),
                    values_from = c("has_mechanic"),
                    id_cols = c("game_id"),
                    names_sep = "_",
                    values_fill = 0)

game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0)


game_mechanics %>%
        group_by(mechanic_id, mechanic) %>%
        count() %>%
        ungroup() %>%
        slice_max(n, 
                  n = 50) %>%
        ggplot(., aes(y=reorder(mechanic,n),
                      x=n))+
        geom_col()+
        theme_phil()+
        theme(axis.text.y = element_text(size=6))+
        ylab("")+
        xlab("Number of Games with Mechanic")

```
We can create an upset plot for the most frequent mechanics and combinations

```{r make upset plot for mechanics, warning=F, message=F, fig.height=10}

library(UpSetR)

temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 4,
     line.size=1.5,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - All Games", x=0.65, y=.99, gp=gpar(fontsize=24))


```

We can filter this in a variety of different ways. Let's restrict to only games in the BGG top 500.

```{r fig.height=10}


temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0) %>%
        left_join(., active_games) %>%
        filter(rank<=1000)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 3,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - BGG Top 1000", x=0.65, y=.99, gp=gpar(fontsize=24))

```
Mechanic popularity over time.

```{r plot mechanic count in games published over time, fig.height=4}

number_mechanics = 20

# get top
most_popular_mechanics <- game_mechanics %>%
        group_by(mechanic, mechanic_id) %>%
        summarize(n = n_distinct(game_id)) %>%
        ungroup() %>%
        slice_max(., 
                  order_by = n,
                  n=number_mechanics) %>%
        pull(mechanic)

library(randomcoloR)
set.seed(12)                                   # Set random seed
palette <- distinctColorPalette(number_mechanics)              # Sample colors
 
# plot over time
library(plotly) 

ggplotly(
game_mechanics %>%
        left_join(., game_info) %>%
        filter(yearpublished >= 1970) %>%
        filter(yearpublished < 2021) %>%
        group_by(mechanic_id, mechanic, yearpublished) %>%
        summarize(games = n_distinct(game_id),
                  .groups = 'drop') %>%
        mutate(date = as.Date(paste(yearpublished, "01", "01", sep="-"))) %>%
        mutate(mech_color = case_when(mechanic %in% most_popular_mechanics ~ mechanic,
                                      TRUE ~ NA_character_)) %>%
        mutate(mech_label = case_when(date == max(date)  ~ mech_color,
                                       TRUE ~ NA_character_)) %>%
        filter(!is.na(mech_color)) %>%
        ggplot(., aes(x=date,
                      color = mechanic,
                      y=games,
                      group = mechanic_id))+
      #  geom_point(size=0.01)+
        geom_line(lwd=.8,
                  alpha=0.8)+
      #  geom_text_repel(show.legend = F)+
        theme_phil()+
        xlab("Year Published")+
        ylab("Number of Games")+
        scale_color_manual(values = palette)+
        guides(label = "none",
               color = guide_legend(element_text(size = 4)))
)
             
```

We can see which mechanics are growing the fastest in recent years.

```{r}

mechanics_look<-c("Paper-and-Pencil",
                  "Worker Placement",
                  "Deck, Bag, and Pool Building",
                  "Variable Player Powers")

ggplotly(
game_mechanics %>%
        left_join(., game_info) %>%
        filter(yearpublished >= 1970) %>%
        filter(yearpublished < 2020) %>%
        group_by(mechanic_id, mechanic, yearpublished) %>%
        summarize(games = n_distinct(game_id),
                  .groups = 'drop') %>%
        left_join(., mechanics_with_most_growth) %>%
        mutate(date = as.Date(paste(yearpublished, "01", "01", sep="-"))) %>%
        filter(mechanic %in% mechanics_look) %>%
        ggplot(., aes(x=date,
                      color = mechanic,
                      y=games,
                      group = mechanic_id))+
      #  geom_point(size=0.01)+
        geom_line(lwd=0.9,
                  alpha=0.5)+
      #  geom_text_repel(show.legend = F)+
        theme_phil()+
        xlab("Year Published")+
        ylab("Number of Games")+
     #   scale_color_manual(values = palette)+
        guides(label = "none",
               color = guide_legend(element_text(size = 4)))
)
   
```

I want to see this for specific publishers.

```{r whoi are the most frequent publishers, warning=F, message=F}

# most frequent publishers
game_publishers %>% 
        group_by(publisher, publisher_id) %>% 
        summarize(games_published = n_distinct(game_id)) %>% 
        ungroup() %>%
        arrange(desc(games_published)) %>%
        slice_max(., 
                  order_by = games_published,
                  n = 50) %>%
        ggplot(., aes(y = reorder(publisher, games_published),
                      x = games_published))+
        geom_col()+
        theme_phil()+
        xlab("Games Published")+
        ylab("Publisher")+
        theme(axis.text.y = element_text(size=5))

```


```{r pivot publishers, fig.height=10}

publishers_pivot<-game_publishers %>%
       # filter(game_id == 124361) %>%
        mutate(publisher = tolower(paste("pub", gsub("[[:space:]]", "_", gsub("\\s+", " ", gsub("[[:punct:]]","", publisher))), sep="_"))) %>%
        mutate(has_publisher = 1) %>%
        select(-publisher_id) %>%
        pivot_wider(names_from = c("publisher"),
                    values_from = c("has_publisher"),
                    id_cols = c("game_id"),
                    names_sep = "_",
                    values_fn = min,
                    values_fill = 0)

```

Look at specific publishers.

```{r look at mechanic combos for top publishers, fig.height=10}

# fantasy flight
temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0) %>%
        left_join(., active_games) %>%
        left_join(., publishers_pivot) %>%
        filter(pub_fantasy_flight_games == 1)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

rm(temp)

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 3,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - Fantasy Flight", x=0.65, y=.99, gp=gpar(fontsize=24))


## zman
temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0) %>%
        left_join(., active_games) %>%
        left_join(., publishers_pivot) %>%
        filter(pub_zman_games == 1)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

rm(temp)

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 3,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - Z Man Games", x=0.65, y=.99, gp=gpar(fontsize=24))



# ravensburger
temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0) %>%
        left_join(., active_games) %>%
        left_join(., publishers_pivot) %>%
        filter(pub_ravensburger == 1)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

rm(temp)

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 3,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - Ravensburger", x=0.65, y=.99, gp=gpar(fontsize=24))



# pegasus spiele
temp<-game_info %>%
        left_join(., mechanics_pivot,
                  by="game_id") %>%
         mutate_at(vars(starts_with('mech_')),
                   .funs = replace_na, 0) %>%
        left_join(., active_games) %>%
        left_join(., publishers_pivot) %>%
        filter(pub_pegasus_spiele == 1)

cols<-names(temp) %>% grep("^[mech_].*", ., value=T)

temp2<-temp %>%
        select(game_id, one_of(cols)) %>%
        as.data.frame()

names(temp2)<-gsub("mech_", "", names(temp2))

rm(temp)

upset_plot<-upset(temp2,
     # sets=gsub("mech_", "", cols),
      nsets = 25,
     show.numbers = F,
     text.scale = 3,
     point.size = 3,
     nintersects = 75,
      mb.ratio = c(.25, .75),
      mainbar.y.label = "# of Games with \n Combination of Mechanics",
      sets.x.label = "# of Games with Mechanic",
      order.by = "freq")

upset_plot
grid.text("Board Game Mechanic Combinations - Pegasus Speile", x=0.65, y=.99, gp=gpar(fontsize=24))

```

